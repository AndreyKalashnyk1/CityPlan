/* ============================================================
   –ê–†–•–Ü–¢–ï–ö–¢–£–†–ê JAVASCRIPT –ö–û–î–£
   ============================================================ */

// –°–¢–†–£–ö–¢–£–†–ê –î–û–î–ê–¢–ö–£:
// CityMapConstructor (–∫–ª–∞—Å) ‚Üí —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –≤—Å—ñ–º–∞ —Ñ—É–Ω–∫—Ü—ñ—è–º–∏

// ============================================================
// 1. –Ü–ù–Ü–¶–Ü–ê–õ–Ü–ó–ê–¶–Ü–Ø
// ============================================================

constructor() {
    // –°—Ç–∞–Ω –¥–æ–¥–∞—Ç–∫—É
    this.objects = []        // –ú–∞—Å–∏–≤ –æ–±'—î–∫—Ç—ñ–≤ –Ω–∞ –∫–∞—Ä—Ç—ñ
    this.history = []        // –Ü—Å—Ç–æ—Ä—ñ—è –¥—ñ–π (–¥–ª—è undo)
    this.selectedTool = null // –í–∏–±—Ä–∞–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç
    this.selectedObject = null // –í–∏–±—Ä–∞–Ω–∏–π –æ–±'—î–∫—Ç
    this.isDragging = false  // –§–ª–∞–≥ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
    this.filters = {...}     // –û–±'—î–∫—Ç —Ñ—ñ–ª—å—Ç—Ä—ñ–≤
    
    // –ü–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ DOM –µ–ª–µ–º–µ–Ω—Ç–∏
    this.canvas = ...
    this.toolButtons = ...
    this.filterCheckboxes = ...
    // —Ç–æ—â–æ...
    
    // –ó–∞–ø—É—Å–∫–∞—î–º–æ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é
    this.init()
}

// ============================================================
// 2. –£–ü–†–ê–í–õ–Ü–ù–ù–Ø –Ü–ù–°–¢–†–£–ú–ï–ù–¢–ê–ú–ò
// ============================================================

selectTool(btn) {
    // –ê–∫—Ç–∏–≤—É—î —Ä–µ–∂–∏–º –¥–æ–¥–∞–≤–∞–Ω–Ω—è –æ–±'—î–∫—Ç–∞
    // –ú—ñ–Ω—è—î —Å—Ç–∏–ª—ñ –∫–Ω–æ–ø–∫–∏ (ÌÅ¥–∞—Å—Å .active)
    // –û–Ω–æ–≤–ª—é—î —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ä–µ–∂–∏–º—É
}

deselectTool() {
    // –î–µ–∞–∫—Ç–∏–≤—É—î —Ä–µ–∂–∏–º –¥–æ–¥–∞–≤–∞–Ω–Ω—è
}

updateModeIndicator() {
    // –ü–æ–∫–∞–∑—É—î –∞–∫—Ç–∏–≤–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –≤ —ñ–Ω–¥–∏–∫–∞—Ç–æ—Ä—ñ
    // –ü—Ä–∏–∫–ª–∞–¥: "–î–æ–¥–∞–≤–∞–Ω–Ω—è: –ë—É–¥–∏–Ω–æ–∫"
}

// ============================================================
// 3. –û–ë–†–û–ë–ö–ê –ü–û–î–Ü–ô –•–û–õ–°–¢–£
// ============================================================

handleCanvasClick(e) {
    // 1. –û—Ç—Ä–∏–º—É—î–º–æ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –∫–ª—ñ–∫
    // 2. –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –±—É–ª–æ –Ω–∞–∂–∞—Ç–æ –Ω–∞ –æ–±'—î–∫—Ç
    //    - —è–∫—â–æ —Ç–∞–∫ ‚Üí selectObject()
    // 3. –Ø–∫—â–æ –≤–∏–±—Ä–∞–Ω —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç ‚Üí addObject()
}

handleCanvasMouseMove(e) {
    // 1. –Ø–∫—â–æ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è ‚Üí –æ–Ω–æ–≤–ª—é—î–º–æ –ø–æ–∑–∏—Ü—ñ—é –æ–±'—î–∫—Ç–∞
    // 2. –ú—ñ–Ω—è—î–º–æ –∫—É—Ä—Å–æ—Ä –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É:
    //    - 'grab' —è–∫—â–æ –Ω–∞–¥ –æ–±'—î–∫—Ç–æ–º
    //    - 'crosshair' —è–∫—â–æ –∞–∫—Ç–∏–≤–Ω–∏–π —Ä–µ–∂–∏–º
    //    - 'default' —ñ–Ω–∞–∫—à–µ
}

handleCanvasMouseUp() {
    // –ó–∞–≤–µ—Ä—à—É—î–º–æ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
}

// ============================================================
// 4. –î–û–î–ê–í–ê–ù–ù–Ø –û–ë'–Ñ–ö–¢–Ü–í
// ============================================================

addObject(type, x, y) {
    // 1. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é (–¥–ª—è undo)
    // 2. –°—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –æ–±'—î–∫—Ç –∑ ID, —Ç–∏–ø–æ–º, –ø–æ–∑–∏—Ü—ñ—î—é, —Ä–æ–∑–º—ñ—Ä–æ–º
    // 3. –î–æ–¥–∞—î–º–æ –≤ –º–∞—Å–∏–≤ objects
    // 4. –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    // 5. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—É—î–º–æ —Ö–æ–ª—Å—Ç
    
    const newObject = {
        id: Date.now(),      // —É–Ω—ñ–∫–∞–ª—å–Ω–∏–π ID
        type: type,          // 'house', 'road', —ñ —Ç.–¥.
        x: x, y: y,         // –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –Ω–∞ –∫–∞—Ä—Ç—ñ
        size: 40,           // —Ä–æ–∑–º—ñ—Ä –æ–±'—î–∫—Ç–∞
        // ...
    }
}

// ============================================================
// 5. –í–ò–î–Ü–õ–ï–ù–ù–Ø –Ü –í–ò–î–ê–õ–ï–ù–ù–Ø
// ============================================================

selectObject(obj) {
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î –æ–±'—î–∫—Ç —è–∫ –≤–∏–±—Ä–∞–Ω–∏–π
    // –ü–æ–∑–Ω–∞—á–∞—î –π–æ–≥–æ —è–∫ selected (–∑–µ–ª–µ–Ω–∞ –æ–±–≤—ñ–¥–∫–∞)
    // –ì–æ—Ç—É—î –¥–æ –ø–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è
}

showDeleteModal() {
    // –ü–æ–∫–∞–∑—É—î –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–Ω—è
    this.deleteModal.classList.add('show')
}

confirmDelete() {
    // 1. –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é
    // 2. –í–∏–¥–∞–ª—è—î–º–æ –æ–±'—î–∫—Ç –∑ –º–∞—Å–∏–≤—É objects
    // 3. –û—á–∏—â—É—î–º–æ selectedObject
    // 4. –û–Ω–æ–≤–ª—é—î–º–æ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    // 5. –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—É—î–º–æ —Ö–æ–ª—Å—Ç
    // 6. –ó–∞–∫—Ä–∏–≤–∞—î–º–æ –º–æ–¥–∞–ª—å–Ω–µ –≤—ñ–∫–Ω–æ
    // 7. –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
}

// ============================================================
// 6. –§–Ü–õ–¨–¢–†–ê–¶–Ü–Ø
// ============================================================

toggleFilter(e) {
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Å—Ç–∞–Ω —Ñ—ñ–ª—å—Ç—Ä—É
    // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤—É—î–º–æ —Ö–æ–ª—Å—Ç (–æ–±'—î–∫—Ç–∏ –ø—Ä–∏—Ö–æ–≤—É—é—Ç—å—Å—è)
    
    // –í–∞–∂–ª–∏–≤–æ: –æ–±'—î–∫—Ç–∏ –ù–ï –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è, —Ç—ñ–ª—å–∫–∏ –ø—Ä–∏—Ö–æ–≤—É—é—Ç—å—Å—è!
}

// ============================================================
// 7. –°–ö–ê–°–£–í–ê–ù–ù–Ø –î–Ü–ô (UNDO)
// ============================================================

saveHistory() {
    // –ü–µ—Ä–µ–¥ –∑–º—ñ–Ω–∞–º–∏ –∑–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π —Å—Ç–∞–Ω –æ–±'—î–∫—Ç—ñ–≤
    this.history.push(JSON.stringify(this.objects))
    
    // –û–±–º–µ–∂—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é –¥–æ 50 –∫—Ä–æ–∫—ñ–≤ (–¥–ª—è –ø–∞–º—è—Ç–∏)
    if (this.history.length > 50) {
        this.history.shift()
    }
    
    // –û–Ω–æ–≤–ª—é—î–º–æ –∫–Ω–æ–ø–∫—É Undo
    this.updateUndoButton()
}

undo() {
    // –ï—Å–ª–∏ —ñ—Å—Ç–æ—Ä—ñ—è –ø–æ—Ä–æ–∂–Ω—è ‚Üí –≤–∏—Ö—ñ–¥
    if (this.history.length === 0) return
    
    // –û—Ç—Ä–∏–º—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Å—Ç–∞–Ω
    const previousState = this.history.pop()
    
    // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª—é—î–º–æ —Å—Ç–∞–Ω
    this.objects = JSON.parse(previousState)
    
    // –û—á–∏—â—É—î–º–æ –≤–∏–±—ñ—Ä
    this.selectedObject = null
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å
    this.updateStats()
    this.updateUndoButton()
    this.render()
    this.showNotification('–î—ñ—è —Å–∫–∞—Å–æ–≤–∞–Ω–∞')
}

// ============================================================
// 8. –°–¢–ê–¢–ò–°–¢–ò–ö–ê
// ============================================================

updateStats() {
    // –õ—ñ—á–∏–º–æ –æ–±'—î–∫—Ç–∏ –∫–æ–∂–Ω–æ–≥–æ —Ç–∏–ø—É
    const counts = {
        house: 0, road: 0, school: 0, hospital: 0, park: 0
    }
    
    this.objects.forEach(obj => {
        counts[obj.type]++
    })
    
    // –û–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ
    this.statsElements.totalObjects.textContent = this.objects.length
    this.statsElements.houseCount.textContent = counts.house
    // —ñ —Ç.–¥.
}

// ============================================================
// 9. –ó–ë–ï–†–ï–ñ–ï–ù–ù–Ø –Ü –ó–ê–í–ê–ù–¢–ê–ñ–ï–ù–ù–Ø
// ============================================================

saveToStorage() {
    // –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –º–∞—Å–∏–≤ objects —É localStorage —è–∫ JSON
    localStorage.setItem(CONFIG.storage.key, JSON.stringify(this.objects))
    this.showNotification('–ü–ª–∞–Ω —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!')
}

loadFromStorage() {
    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑—Ü—ñ —Å—Ç–æ—Ä—ñ–Ω–∫–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂—É—î–º–æ –¥–∞–Ω—ñ –∑ localStorage
    const stored = localStorage.getItem(CONFIG.storage.key)
    if (stored) {
        this.objects = JSON.parse(stored)
        this.updateStats()
    }
}

// ============================================================
// 10. –†–ï–ù–î–ï–†–ò–ù–ì (–º–∞–ª—é–≤–∞–Ω–Ω—è)
// ============================================================

render() {
    // 1. –û—á–∏—â—É—î–º–æ —Ö–æ–ª—Å—Ç
    while (this.canvas.firstChild) {
        this.canvas.removeChild(this.canvas.firstChild)
    }
    
    // 2. –î–ª—è –∫–æ–∂–Ω–æ–≥–æ –æ–±'—î–∫—Ç–∞:
    this.objects.forEach(obj => {
        // - –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ñ—ñ–ª—å—Ç—Ä (skip —è–∫—â–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–π)
        if (!this.filters[obj.type]) return
        
        // - –°—Ç–≤–æ—Ä—é—î–º–æ –°–í–ì –µ–ª–µ–º–µ–Ω—Ç
        const element = this.createObjectElement(obj)
        
        // - –î–æ–¥–∞—î–º–æ –Ω–∞ —Ö–æ–ª—Å—Ç
        this.canvas.appendChild(element)
        
        // - –î–æ–¥–∞—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π
        // ... (–≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø—Ä–∏ –ø–æ–¥–≤—ñ–π–Ω–æ–º—É –∫–ª—ñ–∫—É)
    })
}

createObjectElement(obj) {
    // –°—Ç–≤–æ—Ä—é—î–º–æ –≥—Ä—É–ø–∞ –°–í–ì –µ–ª–µ–º–µ–Ω—Ç—ñ–≤:
    // - –ö—Ä—É–≥ (circle) ‚Üí –∫–æ–ª—ñ—Ä –æ–±'—î–∫—Ç–∞
    // - –¢–µ–∫—Å—Ç (text) ‚Üí —ñ–∫–æ–Ω–∫–∞ (emoji)
    
    // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å 'map-object' –¥–ª—è —Å—Ç–∏–ª—ñ–∑–∞—Ü—ñ—ó
    // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å—Å 'selected' —è–∫—â–æ —Ü–µ –≤–∏–±—Ä–∞–Ω–∏–π –æ–±'—î–∫—Ç
    // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å 'dragging' —è–∫—â–æ –ø–µ—Ä–µ—Ç—è–≥—É—î–º–æ
    
    // –†–µ–∑—É–ª—å—Ç–∞—Ç: <g class="map-object selected">
    //               <circle ... />
    //               <text>üè†</text>
    //            </g>
}

// ============================================================
// 11. –£–¢–ò–õ–Ü–¢–ò
// ============================================================

getObjectAtPoint(x, y) {
    // –ó–Ω–∞—Ö–æ–¥–∏—Ç—å –æ–±'—î–∫—Ç —É –ø–æ–∑–∏—Ü—ñ—ó (x, y)
    // –ü—Ä–æ—Ö–æ–¥–∏–º–æ –º–∞—Å–∏–≤ –≤ –∑–≤–æ—Ä–æ—Ç–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É
    // (–æ—Å—Ç–∞–Ω–Ω—ñ–π = –≤–µ—Ä—Ö–Ω—ñ–π –Ω–∞ –µ–∫—Ä–∞–Ω—ñ)
    
    // –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –¥–∏—Å—Ç–∞–Ω—Ü—ñ—é –≤—ñ–¥ –∫—É—Ä—Å–æ—Ä—É –¥–æ —Ü–µ–Ω—Ç—Ä—É –æ–±'—î–∫—Ç–∞
    // –Ø–∫—â–æ –¥–∏—Å—Ç–∞–Ω—Ü—ñ—è < size/2 ‚Üí —Ü–µ –Ω–∞—à –æ–±'—î–∫—Ç
}

showNotification(message) {
    // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –≤–Ω–∏–∑—É –µ–∫—Ä–∞–Ω–∞
    // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ —Ç–µ–∫—Å—Ç
    // –î–æ–¥–∞—î–º–æ –∫–ª–∞—Å .show (CSS –∞–Ω—ñ–º–∞—Ü—ñ—è)
    // –ß–µ—Ä–µ–∑ 2 —Å–µ–∫ –≤–∏–¥–∞–ª—è—î–º–æ –∫–ª–∞—Å
}

// ============================================================
// –ü–û–¢–Ü–ö –í–ò–ö–û–ù–ê–ù–ù–Ø –û–°–ù–û–í–ù–ò–• –î–Ü–ô
// ============================================================

// –î–Ü–Ø 1: –î–æ–¥–∞–≤–∞–Ω–Ω—è –æ–±'—î–∫—Ç–∞
// 1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–ª—ñ–∫–∞—î –Ω–∞ –∫–Ω–æ–ø–∫—É "–ë—É–¥–∏–Ω–∫–∏"
// 2. selectTool() –∞–∫—Ç–∏–≤—É—î —Ä–µ–∂–∏–º
// 3. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–ª—ñ–∫–∞—î –Ω–∞ –∫–∞—Ä—Ç—É
// 4. handleCanvasClick() –≤–∏–∫–ª–∏–∫–∞ addObject()
// 5. addObject():
//    - saveHistory() ‚Üí {–Ω–∞—è–≤–Ω–∏–π —Å—Ç–∞–Ω –≤ —ñ—Å—Ç–æ—Ä—ñ—é}
//    - {–¥–æ–¥–∞—Ç–∏ –æ–±'—î–∫—Ç –≤ –º–∞—Å–∏–≤}
//    - updateStats()
//    - render() ‚Üí {–º–∞–ª—é–≤–∞–Ω–Ω—è –Ω–∞ —Ö–æ–ª—Å—Ç}

// –î–Ü–Ø 2: –ü–µ—Ä–µ—Ç—è–≥—É–≤–∞–Ω–Ω—è –æ–±'—î–∫—Ç–∞
// 1. handleCanvasClick() –≤–∏–∫–ª–∏–∫–∞ selectObject()
// 2. handleCanvasMouseMove():
//    - {–æ–Ω–æ–≤–ª–µ–Ω–Ω—è X, Y –ø–æ–∑–∏—Ü—ñ—ó}
//    - render() ‚Üí {–ø–µ—Ä–µ–º–∞–ª—é–≤–∞–Ω–Ω—è}
// 3. handleCanvasMouseUp() ‚Üí –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è

// –î–Ü–Ø 3: –í–∏–¥–∞–ª–µ–Ω–Ω—è –æ–±'—î–∫—Ç–∞
// 1. showDeleteModal() ‚Üí –ø–æ–∫–∞–∑ –≤—ñ–∫–Ω–∞
// 2. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –∫–ª—ñ–∫–∞—î "–í–∏–¥–∞–ª–∏—Ç–∏"
// 3. confirmDelete():
//    - saveHistory()
//    - {–≤–∏–¥–∞–ª–µ–Ω–Ω—è –∑ –º–∞—Å–∏–≤—É}
//    - updateStats()
//    - render()

// –î–Ü–Ø 4: –°–∫–∞—Å—É–≤–∞–Ω–Ω—è
// 1. –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–∞—Ç–∏—Å–∫–∞—î Ctrl+Z
// 2. undo():
//    - {–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ —Å—Ç–∞–Ω—É}
//    - updateStats()
//    - render()

// ============================================================
// –ö–û–ù–¢–†–û–õ–¨–ù–ò–ô –°–ü–ò–°–û–ö (–¥–ª—è —Ä–æ–∑—É–º—ñ–Ω–Ω—è –∫–æ–¥—É)
// ============================================================

// [‚úì] –†–æ–∑—É–º—ñ—é —è–∫ –ø—Ä–∞—Ü—é—î –º–∞—Å–∏–≤ objects
// [‚úì] –†–æ–∑—É–º—ñ—é —è–∫ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —ñ—Å—Ç–æ—Ä—ñ—è –¥–ª—è undo
// [‚úì] –†–æ–∑—É–º—ñ—é —è–∫ –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è –∫–ª–∞—Ü–∞–Ω–Ω—è –Ω–∞ —Ö–æ–ª—Å—Ç
// [‚úì] –†–æ–∑—É–º—ñ—é —è–∫ –º–∞–ª—é—é—Ç—å—Å—è –°–í–ì –µ–ª–µ–º–µ–Ω—Ç–∏
// [‚úì] –†–æ–∑—É–º—ñ—é —è–∫ –ø—Ä–∞—Ü—é—î —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—è
// [‚úì] –†–æ–∑—É–º—ñ—é —è–∫ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –¥–∞–Ω—ñ –≤ localStorage
// [‚úì] –†–æ–∑—É–º—ñ—é —è–∫ –ø—Ä–∞—Ü—é—é—Ç—å –µ–≤—Ä–∏—Å—Ç–∏–∫–∏ UX

